4399运营SDK服务端接入说明
===============
[1. 登录凭证验证接口](#登录凭证验证接口)   
[2. 充值回调接口](#充值回调接口)   
[3. 订单信息查询接口](#订单信息查询接口)   
[附1 签名说明](#签名说明)   



## 登录凭证验证接口
### 接口说明
用户登录后，4399运营SDK（以下简称SDK）客户端将返回用户信息的同时，返回用户登录凭证`state`，游戏方服务器可通过该接口验证用户登录凭证的合法性。

### 接口定义
- 接口名称：登录凭证验证接口
- 接口描述：用户登录时用于检验用户登录凭证合法性
- 接口协议：GET 
- 接口开发：4399平台
- 接口地址：http://m.4399api.com/openapi/oauth-check.html  

### 请求参数
   字段    |   必填    |   数据类型    |   说明    
-----------|-----------|---------------|-----------
state|是|string|登录后SDK获取的服务端TOKEN  
uid  |是|unsigned int   |my或4399平台的用户id，无符号整型，范围是0～2^32-1，`php`不区分整型还是字符串；若以整型方式使用它时，需要注意溢出风险，凡是涉及到`uid`的地方都要注意这点


### 返回结果
```json
{
    "code":100,
    "result":{"uid":"1"},
    "message":"验证成功"
}

```
  

参数名| 说明
-------|-----
code        |状态码:<BR/>`100`:验证成功<BR/>`87`:参数不全<BR/>`85`:验证失败  <BR/>`82`:验证成功、但state有效期超时，重置state
message     |对应`code`的返回值描述
result      |返回当前登录用户的 uid


## 充值回调接口
### 接口说明
用户充值成功后，SDK服务端将充值信息回调到游戏方服务端，游戏方服务端应在5秒内返回充值结果，否则将判定订单为异常订单。
只有确认订单是失败的情况下，才返回失败的返回值，当充值中心收到失败的返回值时，将退还用户的充值金额到游币账户，此后若该笔订单在游戏里又处理成充值成功，将造成充值金额的损失。

### 接口定义
- 接口名称：充值回调接口
- 接口描述：用户充值时，手机平台将请求本接口通知游戏方进行充值
- 接口协议：GET 
- 接口开发：游戏方

### 请求参数
   字段    |   必填    |   数据类型    |   说明    
-----------|-----------|---------------|-----------
orderid | 是|string|(4399生成的订单号) 22位以内的字符串 唯一
p_type|是|int|充值渠道id
uid|是|unsigned int|要充值的用户ID，my平台的用户uid 
money|是|float|用户充值的人民币金额，单位：元 
gamemoney|是|int|兑换的游戏币数量，兑换标准由双方共同约定，若在标准兑换比率基础上，有一些优惠或者赠送策略，可无视此数据，由应用端自行计算实际的兑换数额
serverid|否|int|要充值的服务区号。只针对有分服的游戏有效。参数的格式为：区服id。 例如 1服 为 1,  11服为 11
mark|否|string|作为预留字段，部分游戏在游戏内发起充值时，会生成唯一标识来标注该笔充值的相关信息时，可以用本字段。（游戏方生成的订单号）
roleid|否|int|要充值的游戏角色id，只针对pc端充值时，需要选择游戏角色的游戏有效。roleid的值由角色接口提供（见接口2）
time|是|int|发起请求时的时间戳
sign|是|string|加密签名，签名计算为：`$sign` = md5(`$orderid` . `$uid` . `$money` . `$gamemoney` . `$serverid` . `$secrect` . `$mark` . `$roleid`.`$time`); 当参数`$serverid`,`$mark` ,`$roleid`为空时，不参与签名计算。详见[签名说明](#签名说明)。


### 返回结果
```json
{
    "status":2,
    "code":null,
    "money":"1",
    "game_money":"10",
    "msg":"充值成功"
}
```



参数名| 说明  
-------|-----
status |`1`：异常；<BR/>`2`：成功；<BR/>`3`：失败（将钱返还给用户）
code|异常状态码，成功或失败为空。<BR/>`sign_error`:请求串的md5验证码错误<BR/>`user_not_exist`:用户账号不存在<BR/>`orderid_exist`:订单已提交（提交订单号必须唯一)<BR/>`money_error`:充值金额或兑换游戏币数量错误，充值金额为正整数，需符合双方约定的兑换标准<BR/>`other_error`:其他错误
money|用户充值的人民币金额，单位：元 
gamemoney|用户实际兑换的游戏币的数量  
msg|开发商自定义的内容（返回结果的说明等）


## 订单信息查询接口
### 接口定义
- 接口名称：订单信息查询接口
- 接口描述：根据订单号，获取订单信息
- 接口协议：GET
- 接口开发：游戏方

### 请求参数
   字段    |   必填    |   数据类型    |   说明    
-----------|-----------|---------------|-----------
order   |   是  |   string  |   订单号
time    |   是  |   int     |   发起请求时的时间戳
serverid|   否  |   int     |   充值对应的服务器id，如果不需要该参数或者无服务器概念的游戏，可无视
flag    |   是  |   string  |   加密签名，签名计算为：`$flag` = md5(`$order` . `$time` . `$secrect`);详见[签名说明](#签名说明)。  


### 返回结果
```json
若订单正确将返回JSON格式订单数据
{
    "order":"1313164",
    "uid":"123456",
    "money":"2234",
    "gamemoney":"1234",
    "time":"2012-12-25 07:59:59",
    "nickname":"\u6ef4\u6ef4",
    "serve_id":"1",
    "status":"1"
}

若订单错误则返回错误代码例如：
-1
```

 

参数名| 说明
-------|-----
order|订单号
uid|即4399的用户`uid`
money|用户充值的人民币金额，单位：元 
gamemoney|游戏币
time|充值的时间，格式：`YYYY-mm-dd HH:ii:ss`
nickname|用户在游戏中的角色名
server_id|充值的游戏服务器id
status|订单状态:<br/>`“1”`：成功 <br/>`“-1”`：失败，充值金额将返还给玩家 <br/> `“0”`：异常，需要人工确认

错误代码    |   说明    
------------|-----------
-1          |订单信息不存在
0           |未知错误
1           |参数错误
2           |验证错误

## 签名说明
1. 参与签名的所有参数为接受到的原始参数，请不要在参与签名计算前对参数做任何处理  
2. 使用标准`MD5`算法对该字符串加密  
3. `$secrect` 为4399自动分配的密钥，仅可用于服务端，请勿将其写入客户端代码中。

